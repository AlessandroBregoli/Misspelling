<!DOCTYPE html>
<html lang="en">
    <head>
        <title>Correttore</title>
        <style type="text/css">
            body, #typing {
                font-family: monospace;
                font-size: 20px;
            }
            #typing {
                width: 100%;
                top: 30px;
                height: 30px;
                border: 1px solid #ccc;
                padding: 2px;
                outline: 0;
                margin: 0;
            }
            #log {
                white-space: pre;
                position: absolute;
                bottom: 0;
                left: 0; right: 0;
                overflow-y: scroll;
                overflow-x: hidden;
                height: 40%;
                background: #002b36;
                color: #eee8d5;
                padding: 5px;
            }
            h3 {
                text-align: center;
                font-size: 20px;
                margin: 0; padding:0;
            }
            #tooltip {
                position: absolute;
                top: 67px;
                left: 5ch;
                border: 1px solid #ccc;
                width: auto;
                visibility: hidden;
            }
            #suggestions {
                list-style: none;
                margin: 0;
                padding: 0;
            }
            #provalarghezza {
                position: absolute;
                visibility: hidden;
                display: block;
                width: 1ch;
            }
            #suggestions li {
                margin: 0;
                padding: 2px;
                cursor: pointer;
            }
            #suggestions li:hover {
                background-color: #eee;
            }
        </style>
    </head>
    <body>
        <h3>qualcosa</h3>
        <div id="provalarghezza"></div>
        <div style="width: auto; left:5ch; right: 5ch; position: absolute;">
            <input type="text" id="typing">
        </div>
        <div id="tooltip"><ul id="suggestions">
            <li>Tanti</li>
            <li>bei</li>
            <li>suggerimenti</li></ul></div>
        <div id="log"></div>
        <script type="text/javascript">
            var ldiv = document.getElementById("log");
            function log(str, end){
                if(end == undefined){
                    end = "\n";
                }
                var txt = document.createTextNode(str + end);
                ldiv.appendChild(txt);
                ldiv.scrollTop = ldiv.scrollHeight;
            }
            log("Correttore spastico v 0.0");
            var typ = document.getElementById("typing");
            var chWidth = document.getElementById("provalarghezza").offsetWidth;
            var tt = document.getElementById("tooltip");
            typ.addEventListener("input", function(){
                var cpos = this.selectionStart;
                var text = typ.value;
                var word = "";
                var words = text.split(" ")
                var scanpos = 0;
                var wcount = 0;
                var wstart = 0;
                while (scanpos < cpos) { 
                    wstart = scanpos;
                    scanpos += words[wcount].length + 1;
                    wcount += 1;
                }
                var wnumb = wcount - 1;
                word = words[wnumb];
                if (word == "" || word == undefined){
                    tt.style.visibility = "hidden";
                    return;
                }
                typ.wstart = wstart;
                //log("edit, posizione: " + cpos + ", parola: " + word + ", wstart: " + wstart);
                //pop_tooltip([word, "pota", "non sai scrivere", "studia"], wstart, word);
                ask(text, word, wnumb, wstart)
            })
            typ.addEventListener("scroll", function() {
                tooltip(this.wstart);
            })
            function tooltip(wstart) {
                tt.style.visibility = "visible";
                if (typ.scrollLeft > 0.1) {
                    wstart -= (typ.scrollLeft / chWidth);
                }
                if (wstart < 0)
                    wstart = 0;
                tt.style.left = (5 + wstart) + "ch";
            }
            var sugg = document.getElementById("suggestions");
            function pop_tooltip (parole, wstart, word) {
                sugg.innerHTML = "";
                for (var x in parole) {
                    var li = document.createElement("li");
                    li.innerHTML = parole[x];
                    add_click_event(li, wstart, word, parole[x]);
                    sugg.appendChild(li);
                }
            }
            function add_click_event(li, wstart, word, parola) {
                li.addEventListener("click", function() {
                    subst_word(wstart, word, parola);
                })
            }
            function subst_word(wstart, word, nword) {
                typ.value = typ.value.substring(0, wstart) + nword + typ.value.substring(wstart + word.length)
                tt.style.visibility = "hidden";
                typ.focus();
                typ.selectionStart  = typ.selectionEnd = wstart + nword.length;
            }
            var mat = [];
            function ask (phrase, word, wnumb, wstart) {
                var req = {
                    "phrase" : phrase.substring(0, wstart + word.length),
                    "mat" : mat.slice(0, wnumb)
                }
                var ajax = new XMLHttpRequest();
                ajax.onreadystatechange = function() {
                    if (this.readyState == 4 && this.status == 200) {
                        // Typical action to be performed when the document is ready
                        var resp = JSON.parse(this.responseText);
                        console.log(resp)
                        pop_tooltip(resp['mat'][wnumb], wstart, word);
                        mat = resp['mat'];
                        tooltip(wstart);
                        log(resp['viterbi'])
                    }
                }
                ajax.open("POST", "localhost:3714/viterbi", true);
                ajax.send(req);
            }
        </script>
    </body>
</html>